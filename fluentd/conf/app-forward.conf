# 接收应用日志的配置
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# 处理不同应用的日志
<match app.**>
  @type google_cloud

  # 使用应用原始时间戳
  use_metadata_service true
  detect_json true
  enable_monitoring false
  
  # 时间戳处理
  adjust_invalid_timestamps false
  # 指定使用应用时间戳字段
  timestamp_key timestamp
  
  # 配置日志资源和标签
  resource_type "generic_task"
  insert_id_key log_id
  labels_key log_labels
  
  # 缓冲设置
  <buffer>
    @type file
    path /var/lib/google-fluentd/app-buffers
    flush_interval 5s
    chunk_limit_size 2M
    total_limit_size 512M
    retry_max_interval 30
    retry_forever false
  </buffer>

  # 自定义日志字段映射
  <custom_labels>
    app_name ${tag_parts[1]}
    instance_id ${tag_parts[2]}
  </custom_labels>
</match>

# 错误处理
<label @ERROR>
  <match **>
    @type file
    path /var/log/google-fluentd/error.log
    append true
    <buffer>
      @type file
      path /var/lib/google-fluentd/error-buffers
      flush_interval 5s
    </buffer>
  </match>
</label> 